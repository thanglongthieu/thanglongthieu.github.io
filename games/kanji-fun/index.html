<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Kanji Fun & Ëªä„Çπ„É©„Ç§„Éâ„Ç≤„Éº„É†</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #050510;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }

    .app {
      box-sizing: border-box;
      width: 100%;
      height: 100%;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .header {
      text-align: center;
    }

    .title {
      font-size: 20px;
      margin-bottom: 2px;
    }

    .sub {
      font-size: 12px;
      opacity: 0.8;
    }

    .top-bar {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .level-area {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
    }

    select {
      font-size: 13px;
      padding: 3px 6px;
      border-radius: 6px;
      border: none;
      margin-bottom: 2px;
    }

    .stats {
      text-align: right;
      flex: 1;
    }

    .stats span {
      margin-left: 6px;
    }

    .mode-buttons {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .mode-btn {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: none;
      background: #333a55;
      color: #fff;
    }

    .mode-btn.active {
      background: #0a84ff;
    }

    .question-box {
      text-align: center;
      margin-top: 4px;
    }

    #readingText {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    #meaningText {
      font-size: 14px;
      opacity: 0.9;
    }

    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow: hidden;
    }

    /* Quiz mode */
    #quizMode {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: stretch;
      gap: 8px;
    }

    .choices {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 10px;
    }

    .choice-btn {
      font-size: 26px;
      padding: 10px 0;
      border-radius: 10px;
      border: none;
      background: #222a40;
      color: #fff;
    }

    .choice-btn:active {
      transform: scale(0.95);
    }

    .choice-btn.correct-show {
      background: #1c8f3f;
    }

    .choice-btn.wrong-show {
      background: #b3261e;
    }

    #quizFeedback {
      text-align: center;
      font-size: 14px;
      min-height: 18px;
    }

    /* Car slide mode */
    #carMode {
      flex: 1;
      display: none;
      flex-direction: column;
      gap: 4px;
      align-items: stretch;
    }

    #carCanvas {
      width: 100%;
      height: 220px;
      background: #141428;
      border-radius: 10px;
      border: 1px solid #444;
      touch-action: none;
    }

    .car-hint {
      font-size: 12px;
      text-align: center;
      opacity: 0.8;
    }

    .bottom-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    #startBtn {
      padding: 8px 20px;
      font-size: 16px;
      border-radius: 999px;
      border: none;
      background: #0a84ff;
      color: #fff;
    }

    #startBtn:active {
      transform: scale(0.96);
    }

    .bottom-hint {
      font-size: 12px;
      text-align: center;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">Kanji Fun Quiz & Ëªä„Çπ„É©„Ç§„Éâ„Ç≤„Éº„É†</div>
      <div class="sub">„Çà„ÅøÔºãÊÑèÂë≥„Å´Âêà„ÅÜÊº¢Â≠ó„Çí„ÄÅËªä„Åß„Ç≠„É£„ÉÉ„ÉÅ„Åó„Çà„ÅÜÔºÅ</div>

      <div class="top-bar">
        <div class="level-area">
          <span>„É¨„Éô„É´:</span>
          <select id="levelSelect">
            <option value="g12">Â∞è1„Äú2 „ÇÑ„Åï„Åó„ÅÑ</option>
            <option value="g3">Â∞è3 Êº¢Â≠ó</option>
            <option value="g4">Â∞è4 Êº¢Â≠ó</option>
            <option value="n5">JLPT N5</option>
          </select>

          <span>„Çπ„Éî„Éº„Éâ („Éâ„É≠„ÉÉ„ÉóLv):</span>
          <select id="speedSelect">
            <option value="lv1">Lv1 üê¢ „Å®„Å¶„ÇÇ„ÇÜ„Å£„Åè„Çä</option>
            <option value="lv2" selected>Lv2 üö∂ „ÇÜ„Å£„Åè„Çä</option>
            <option value="lv3">Lv3 üòÄ „Åµ„Å§„ÅÜ</option>
            <option value="lv4">Lv4 ‚ö° „ÅØ„ÇÑ„ÅÑ</option>
            <option value="lv5">Lv5 üíÄ „ÇÅ„Å°„ÇÉ„ÅØ„ÇÑ„ÅÑ</option>
          </select>
        </div>
        <div class="stats">
          <span>‚è± <span id="time">60</span>s</span>
          <span>‚≠ê <span id="score">0</span></span>
        </div>
      </div>

      <div class="mode-buttons">
        <button id="modeQuizBtn" class="mode-btn active">„Ç´„Éº„Éâ„ÇØ„Ç§„Ç∫</button>
        <button id="modeCarBtn" class="mode-btn">Ëªä„Çπ„É©„Ç§„Éâ</button>
      </div>

      <div class="question-box">
        <div id="readingText">‚Äî</div>
        <div id="meaningText">„Äå„Çπ„Çø„Éº„Éà„Äç„Åß„Ç≤„Éº„É†ÈñãÂßã</div>
      </div>
    </div>

    <div class="main-area">
      <!-- Card Quiz mode -->
      <div id="quizMode">
        <div class="choices">
          <button class="choice-btn" data-index="0"></button>
          <button class="choice-btn" data-index="1"></button>
          <button class="choice-btn" data-index="2"></button>
          <button class="choice-btn" data-index="3"></button>
        </div>
        <div id="quizFeedback"></div>
      </div>

      <!-- Car Slide mode -->
      <div id="carMode">
        <canvas id="carCanvas"></canvas>
        <div class="car-hint">
          „Çà„Åø„Å®ÊÑèÂë≥„Å´Âêà„ÅÜÊº¢Â≠ó„Åå‰∏ä„Åã„ÇâËêΩ„Å°„Å¶„Åè„Çã„Çà„ÄÇ<br />
          „Ç≠„É£„É≥„Éê„Çπ„ÅÆ„ÄåÂàó„Äç„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ëªä„ÇíÂ∑¶Âè≥„Å´„Çπ„É©„Ç§„Éâ„ÄÅ<br />
          Ê≠£„Åó„ÅÑÊº¢Â≠ó„Çí„Å≤„Çç„Å£„Å¶„ÄÅ„Åæ„Å°„Åå„ÅÑ„ÅØ„Åï„Åë„Çà„ÅÜÔºÅ
        </div>
      </div>
    </div>

    <div class="bottom-controls">
      <button id="startBtn">„Çπ„Çø„Éº„Éà / „É™„Çπ„Çø„Éº„Éà</button>
      <div class="bottom-hint">
        Ëªä„É¢„Éº„ÉâÔºö‰∏ä„ÅÆ„Ç≠„É£„É≥„Éê„Çπ„ÅÆÂàó„Çí„Çø„ÉÉ„Éó„Åó„Å¶Â∑¶Âè≥„Å´„Çπ„É©„Ç§„Éâ„ÄÇ<br>
        „Ç´„Éº„Éâ„ÇØ„Ç§„Ç∫ÔºöÊ≠£„Åó„ÅÑÊº¢Â≠ó„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó„ÄÇ
      </div>
    </div>
  </div>

  <script>
    // ---- Kanji datasets (more kanji for each grade) ----
    const kanjiSets = {
      g12: [
        { kanji: '‰∏Ä', reading: '„ÅÑ„Å°', meaning: 'one' },
        { kanji: '‰∫å', reading: '„Å´', meaning: 'two' },
        { kanji: '‰∏â', reading: '„Åï„Çì', meaning: 'three' },
        { kanji: 'Âõõ', reading: '„Çà„Çì / „Åó', meaning: 'four' },
        { kanji: '‰∫î', reading: '„Åî', meaning: 'five' },
        { kanji: 'ÂÖ≠', reading: '„Çç„Åè', meaning: 'six' },
        { kanji: '‰∏É', reading: '„Å™„Å™ / „Åó„Å°', meaning: 'seven' },
        { kanji: 'ÂÖ´', reading: '„ÅØ„Å°', meaning: 'eight' },
        { kanji: '‰πù', reading: '„Åç„ÇÖ„ÅÜ', meaning: 'nine' },
        { kanji: 'ÂçÅ', reading: '„Åò„ÇÖ„ÅÜ', meaning: 'ten' },

        { kanji: 'Â§ß', reading: '„Åä„Åä(„Åç„ÅÑ)', meaning: 'big' },
        { kanji: 'Â∞è', reading: '„Å°„ÅÑ(„Åï„ÅÑ)', meaning: 'small' },
        { kanji: '‰∏ä', reading: '„ÅÜ„Åà', meaning: 'up / above' },
        { kanji: '‰∏ã', reading: '„Åó„Åü', meaning: 'down / below' },
        { kanji: '‰∏≠', reading: '„Å™„Åã', meaning: 'inside / middle' },

        { kanji: 'Êó•', reading: '„Å≤ / „Å´„Å°', meaning: 'day / sun' },
        { kanji: 'Êúà', reading: '„Å§„Åç / „Åí„Å§', meaning: 'moon / month' },
        { kanji: 'Ê∞¥', reading: '„Åø„Åö', meaning: 'water' },
        { kanji: 'ÁÅ´', reading: '„Å≤', meaning: 'fire' },
        { kanji: 'Êú®', reading: '„Åç', meaning: 'tree' },

        { kanji: 'Â±±', reading: '„ÇÑ„Åæ', meaning: 'mountain' },
        { kanji: 'Â∑ù', reading: '„Åã„Çè', meaning: 'river' },
        { kanji: 'Èõ®', reading: '„ÅÇ„ÇÅ', meaning: 'rain' },
        { kanji: 'Áî∞', reading: '„Åü', meaning: 'rice field' },
        { kanji: 'Âè£', reading: '„Åè„Å°', meaning: 'mouth' },
        { kanji: 'ÁõÆ', reading: '„ÇÅ', meaning: 'eye' },
        { kanji: 'ËÄ≥', reading: '„Åø„Åø', meaning: 'ear' },
        { kanji: 'Êâã', reading: '„Å¶', meaning: 'hand' },
        { kanji: 'Ë∂≥', reading: '„ÅÇ„Åó', meaning: 'foot / leg' },
        { kanji: 'Áä¨', reading: '„ÅÑ„Å¨', meaning: 'dog' },
        { kanji: 'Áå´', reading: '„Å≠„Åì', meaning: 'cat' }
      ],
      g3: [
        { kanji: 'Êµ∑', reading: '„ÅÜ„Åø', meaning: 'sea' },
        { kanji: 'Êπñ', reading: '„Åø„Åö„ÅÜ„Åø', meaning: 'lake' },
        { kanji: 'Á©∫', reading: '„Åù„Çâ / „Åè„ÅÜ', meaning: 'sky / empty' },
        { kanji: 'Êòü', reading: '„Åª„Åó', meaning: 'star' },
        { kanji: 'Èáé', reading: '„ÅÆ', meaning: 'field' },

        { kanji: 'Ê£Æ', reading: '„ÇÇ„Çä', meaning: 'forest' },
        { kanji: 'Êûó', reading: '„ÅØ„ÇÑ„Åó', meaning: 'woods' },
        { kanji: 'Ëçâ', reading: '„Åè„Åï', meaning: 'grass' },
        { kanji: 'Ëä±', reading: '„ÅØ„Å™', meaning: 'flower' },
        { kanji: 'È≥•', reading: '„Å®„Çä', meaning: 'bird' },

        { kanji: 'ÂÆ∂', reading: '„ÅÑ„Åà / „Åã', meaning: 'house' },
        { kanji: 'ÂÆ§', reading: '„Åó„Å§', meaning: 'room' },
        { kanji: 'Áî∫', reading: '„Åæ„Å°', meaning: 'town' },
        { kanji: 'Êùë', reading: '„ÇÄ„Çâ', meaning: 'village' },
        { kanji: 'ÈÅì', reading: '„Åø„Å° / „Å©„ÅÜ', meaning: 'road / way' },

        { kanji: 'ÈßÖ', reading: '„Åà„Åç', meaning: 'station' },
        { kanji: 'Ëªä', reading: '„Åè„Çã„Åæ', meaning: 'car' },
        { kanji: 'Èõª', reading: '„Åß„Çì', meaning: 'electricity' },
        { kanji: 'Âõ≥', reading: '„Åö', meaning: 'drawing / diagram' },
        { kanji: 'È§®', reading: '„Åã„Çì', meaning: 'building / hall' },

        { kanji: 'Ê≠å', reading: '„ÅÜ„Åü / „Åã', meaning: 'song' },
        { kanji: 'Ê•Ω', reading: '„Åü„ÅÆ(„Åó„ÅÑ) / „Åå„Åè', meaning: 'fun / music' },
        { kanji: 'Ëå∂', reading: '„Å°„ÇÉ', meaning: 'tea' },
        { kanji: 'Áâõ', reading: '„ÅÜ„Åó', meaning: 'cow' },
        { kanji: 'È¶¨', reading: '„ÅÜ„Åæ', meaning: 'horse' },
        { kanji: 'È≠ö', reading: '„Åï„Åã„Å™', meaning: 'fish' },

        { kanji: 'Êúù', reading: '„ÅÇ„Åï', meaning: 'morning' },
        { kanji: 'Êòº', reading: '„Å≤„Çã', meaning: 'noon / daytime' },
        { kanji: 'Â§ú', reading: '„Çà„Çã', meaning: 'night' },
        { kanji: 'Êõú', reading: '„Çà„ÅÜ', meaning: 'day of week' }
      ],
      g4: [
        { kanji: 'Â∏Ç', reading: '„Åó', meaning: 'city / market' },
        { kanji: 'Âå∫', reading: '„Åè', meaning: 'ward / district' },
        { kanji: 'Áî∫', reading: '„Åæ„Å°', meaning: 'town' },
        { kanji: 'Êùë', reading: '„ÇÄ„Çâ', meaning: 'village' },

        { kanji: 'Áúå', reading: '„Åë„Çì', meaning: 'prefecture' },
        { kanji: 'ÈÉΩ', reading: '„Å® / „Åø„ÇÑ„Åì', meaning: 'capital / metropolis' },
        { kanji: '‰∫¨', reading: '„Åç„Çá„ÅÜ', meaning: 'capital (Kyoto/Tokyo)' },

        { kanji: 'ÊóÖ', reading: '„Åü„Å≥ / „Çä„Çá', meaning: 'trip / travel' },
        { kanji: 'ÈÅä', reading: '„ÅÇ„Åù(„Å∂)', meaning: 'play' },
        { kanji: 'Ê≥≥', reading: '„Åä„Çà(„Åê)', meaning: 'swim' },

        { kanji: 'Ëç∑', reading: '„Å´ / „Åã', meaning: 'luggage / load' },
        { kanji: 'Ê∏Ø', reading: '„Åø„Å™„Å® / „Åì„ÅÜ', meaning: 'harbor / port' },
        { kanji: 'Áô∫', reading: '„ÅØ„Å§ / „Åª„Å§', meaning: 'departure / emit' },

        { kanji: 'Â∫≠', reading: '„Å´„Çè', meaning: 'garden' },
        { kanji: 'Ê©ã', reading: '„ÅØ„Åó', meaning: 'bridge' },
        { kanji: 'Âª∫', reading: '„Åü(„Å¶„Çã)', meaning: 'build' },

        { kanji: 'ÈâÑ', reading: '„Å¶„Å§', meaning: 'iron / railway' },
        { kanji: 'ÈÅã', reading: '„ÅÜ„Çì', meaning: 'carry / luck' },
        { kanji: 'ÊÄ•', reading: '„Åç„ÇÖ„ÅÜ', meaning: 'rapid / urgent' },

        { kanji: 'Ë™¨', reading: '„Åõ„Å§ / „Å®(„Åè)', meaning: 'explain / theory' },
        { kanji: 'Âïè', reading: '„ÇÇ„Çì', meaning: 'question' },
        { kanji: 'È°å', reading: '„Å†„ÅÑ', meaning: 'title / topic' },
        { kanji: 'Á≠î', reading: '„Åì„Åü(„Åà)', meaning: 'answer' },

        { kanji: 'Èñã', reading: '„Å≤„Çâ(„Åè) / „Åã„ÅÑ', meaning: 'open' },
        { kanji: 'Èñâ', reading: '„Å®(„Åò„Çã) / „Å∏„ÅÑ', meaning: 'close' },
        { kanji: 'Âßã', reading: '„ÅØ„Åò(„ÇÅ„Çã)', meaning: 'start' },
        { kanji: 'ÁµÇ', reading: '„Åä(„Çè„Çã)', meaning: 'end' }
      ],
      n5: [
        { kanji: 'Â≠¶', reading: '„Åæ„Å™(„Å∂) / „Åå„Åè', meaning: 'study / learning' },
        { kanji: 'Áîü', reading: '„Åõ„ÅÑ / „ÅÑ(„Åç„Çã)', meaning: 'life / birth' },
        { kanji: 'ÂÖà', reading: '„Åï„Åç / „Åõ„Çì', meaning: 'ahead / previous' },
        { kanji: 'Ê†°', reading: '„Åì„ÅÜ', meaning: 'school' },
        { kanji: 'È´ò', reading: '„Åü„Åã(„ÅÑ)', meaning: 'tall / high' },

        { kanji: 'Ë°å', reading: '„ÅÑ(„Åè) / „Åì„ÅÜ', meaning: 'go / act' },
        { kanji: 'Êù•', reading: '„Åè(„Çã) / „Çâ„ÅÑ', meaning: 'come' },
        { kanji: 'Â∏∞', reading: '„Åã„Åà(„Çã)', meaning: 'return' },

        { kanji: 'Ë¶ã', reading: '„Åø(„Çã) / „Åë„Çì', meaning: 'see / look' },
        { kanji: 'ËÅû', reading: '„Åç(„Åè) / „Å∂„Çì', meaning: 'hear / listen' },
        { kanji: 'Ë®Ä', reading: '„ÅÑ(„ÅÜ)', meaning: 'say' },
        { kanji: 'Ë©±', reading: '„ÅØ„Å™(„Åô) / „Çè', meaning: 'talk / speak' },

        { kanji: 'Êõ∏', reading: '„Åã(„Åè)', meaning: 'write' },
        { kanji: 'Ë™≠', reading: '„Çà(„ÇÄ)', meaning: 'read' },
        { kanji: 'È£ü', reading: '„Åü(„Åπ„Çã) / „Åó„Çá„Åè', meaning: 'eat / food' },
        { kanji: 'È£≤', reading: '„ÅÆ(„ÇÄ)', meaning: 'drink' },

        { kanji: 'Ë≤∑', reading: '„Åã(„ÅÜ)', meaning: 'buy' },
        { kanji: 'Â£≤', reading: '„ÅÜ(„Çã)', meaning: 'sell' },
        { kanji: 'Â∫ó', reading: '„Åø„Åõ / „Å¶„Çì', meaning: 'shop' },

        { kanji: 'ÊôÇ', reading: '„Å®„Åç / „Åò', meaning: 'time / hour' },
        { kanji: 'ÂàÜ', reading: '„Åµ„Çì / „Å∂„Çì', meaning: 'minute / part' },
        { kanji: '‰ªä', reading: '„ÅÑ„Åæ / „Åì„Çì', meaning: 'now' },
        { kanji: 'Ââç', reading: '„Åæ„Åà', meaning: 'before / front' },
        { kanji: 'Âæå', reading: '„ÅÇ„Å® / „Åî', meaning: 'after / behind' },

        { kanji: '‰Ωï', reading: '„Å™„Å´ / „Å™„Çì', meaning: 'what' },
        { kanji: 'ÂõΩ', reading: '„Åè„Å´ / „Åì„Åè', meaning: 'country' },
        { kanji: '‰∫∫', reading: '„Å≤„Å® / „Å´„Çì', meaning: 'person' },
        { kanji: 'Âèã', reading: '„Å®„ÇÇ', meaning: 'friend' }
      ]
    };

    // ---- Shared helpers/state ----
    const levelSelect   = document.getElementById('levelSelect');
    const speedSelect   = document.getElementById('speedSelect');
    const timeSpan      = document.getElementById('time');
    const scoreSpan     = document.getElementById('score');
    const readingText   = document.getElementById('readingText');
    const meaningText   = document.getElementById('meaningText');
    const startBtn      = document.getElementById('startBtn');
    const modeQuizBtn   = document.getElementById('modeQuizBtn');
    const modeCarBtn    = document.getElementById('modeCarBtn');

    const quizModeDiv   = document.getElementById('quizMode');
    const carModeDiv    = document.getElementById('carMode');

    const quizFeedback  = document.getElementById('quizFeedback');
    const choiceButtons = Array.from(document.querySelectorAll('.choice-btn'));

    const carCanvas     = document.getElementById('carCanvas');
    const carCtx        = carCanvas.getContext('2d');

    let currentMode   = 'quiz'; // 'quiz' or 'car'
    let gameRunning   = false;
    let timerId       = null;
    let timeLeft      = 60;
    let score         = 0;
    let currentQuestion = null;

    function getCurrentSet() {
      return kanjiSets[levelSelect.value] || kanjiSets.g12;
    }

    function randomFromArray(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function makeQuestion() {
      const set = getCurrentSet();
      if (!set || set.length === 0) return null;

      const correct = randomFromArray(set);
      const allKanji = set.map(k => k.kanji);
      const choices = new Set();
      choices.add(correct.kanji);

      while (choices.size < 4 && choices.size < allKanji.length) {
        choices.add(randomFromArray(allKanji));
      }

      const choiceArray = Array.from(choices);
      // shuffle
      for (let i = choiceArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [choiceArray[i], choiceArray[j]] = [choiceArray[j], choiceArray[i]];
      }

      return {
        kanji: correct.kanji,
        reading: correct.reading,
        meaning: correct.meaning,
        choices: choiceArray
      };
    }

    function resetCommonState() {
      gameRunning = false;
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      timeLeft = 60;
      timeSpan.textContent = timeLeft;
      score = 0;
      scoreSpan.textContent = score;
      currentQuestion = null;
      readingText.textContent = '‚Äî';
      meaningText.textContent = '„Äå„Çπ„Çø„Éº„Éà„Äç„Åß„Ç≤„Éº„É†ÈñãÂßã';
    }

    // ---- Quiz Mode ----
    function setupQuizQuestion() {
      const q = makeQuestion();
      if (!q) return;
      currentQuestion = q;

      readingText.textContent = q.reading;
      meaningText.textContent = q.meaning;
      quizFeedback.textContent = '';

      choiceButtons.forEach((btn, idx) => {
        btn.textContent = q.choices[idx] || '';
        btn.classList.remove('correct-show', 'wrong-show');
        btn.disabled = !gameRunning;
      });
    }

    function handleQuizChoice(btn) {
      if (!gameRunning || currentMode !== 'quiz' || !currentQuestion) return;
      const chosen = btn.textContent;

      choiceButtons.forEach(b => b.classList.remove('correct-show', 'wrong-show'));

      if (chosen === currentQuestion.kanji) {
        score++;
        scoreSpan.textContent = score;
        quizFeedback.textContent = '‚úÖ Ê≠£Ëß£ÔºÅ';
        btn.classList.add('correct-show');
      } else {
        quizFeedback.textContent = `‚ùå „Åñ„Çì„Å≠„Çì‚Ä¶ Ê≠£Ëß£„ÅØ„Äå${currentQuestion.kanji}„Äç`;
        btn.classList.add('wrong-show');
        const correctBtn = choiceButtons.find(
          b => b.textContent === currentQuestion.kanji
        );
        if (correctBtn) correctBtn.classList.add('correct-show');
      }

      setTimeout(() => {
        if (gameRunning && currentMode === 'quiz') {
          setupQuizQuestion();
        }
      }, 600);
    }

    choiceButtons.forEach(btn => {
      btn.addEventListener('click', () => handleQuizChoice(btn));
      btn.addEventListener('touchstart', e => {
        e.preventDefault();
        handleQuizChoice(btn);
      }, { passive: false });
    });

    // ---- Car Slide Mode (falling kanji, 3 lanes) ----
    const LANES = 3;
    let laneWidth = 0;
    let carLane   = 1;  // 0..LANES-1
    let carY      = 0;
    let carW      = 40;
    let carH      = 24;

    let obstacles = []; // { lane, y, size, kanji, isCorrect, caught }

    // drop speed levels
    const speedConfig = {
      lv1: { start: 50,  accel: 2 },   // very slow
      lv2: { start: 70,  accel: 3.5 }, // slow
      lv3: { start: 95,  accel: 6 },   // normal
      lv4: { start: 130, accel: 10 },  // fast
      lv5: { start: 170, accel: 15 }   // crazy
    };

    let fallSpeed = speedConfig.lv3.start;
    let lastCarTime = 0;

    function resizeCarCanvas() {
      const rect = carCanvas.getBoundingClientRect();
      carCanvas.width = rect.width;
      carCanvas.height = rect.height;
      laneWidth = carCanvas.width / LANES;
      carY = carCanvas.height - 40;
      carW = Math.min(50, laneWidth * 0.6);
      carH = 24;
    }
    window.addEventListener('resize', resizeCarCanvas);
    resizeCarCanvas();

    function setupCarQuestion() {
      const q = makeQuestion();
      if (!q) return;
      currentQuestion = q;

      readingText.textContent = q.reading;
      meaningText.textContent = q.meaning;

      obstacles = [];

      // set fallSpeed based on speedSelect
      const spdKey = speedSelect.value || 'lv3';
      const cfg = speedConfig[spdKey] || speedConfig.lv3;
      fallSpeed = cfg.start;

      const correctLane = Math.floor(Math.random() * LANES);
      const size = 40;
      const set = getCurrentSet();

      for (let lane = 0; lane < LANES; lane++) {
        let kanji;
        let isCorrect = false;
        if (lane === correctLane) {
          kanji = q.kanji;
          isCorrect = true;
        } else {
          let candidate;
          do {
            candidate = randomFromArray(set).kanji;
          } while (candidate === q.kanji);
          kanji = candidate;
        }
        const yStart = -size - Math.random() * 80;
        obstacles.push({
          lane,
          y: yStart,
          size,
          kanji,
          isCorrect,
          caught: false
        });
      }
    }

    function resetCarState() {
      resizeCarCanvas();
      carLane = 1;
      lastCarTime = performance.now();
      setupCarQuestion();
    }

    function handleCarTap(evt) {
      if (!gameRunning || currentMode !== 'car') return;
      const rect = carCanvas.getBoundingClientRect();
      let x;
      if (evt.touches && evt.touches.length > 0) {
        x = evt.touches[0].clientX;
      } else {
        x = evt.clientX;
      }
      const relX = x - rect.left;
      const tappedLane = Math.floor(relX / laneWidth);
      if (tappedLane >= 0 && tappedLane < LANES) {
        carLane = tappedLane;
      }
    }

    carCanvas.addEventListener('mousedown', handleCarTap);
    carCanvas.addEventListener('touchstart', e => {
      e.preventDefault();
      handleCarTap(e);
    }, { passive: false });

    function carLoop(timestamp) {
      if (!gameRunning || currentMode !== 'car') return;

      const dt = (timestamp - lastCarTime) / 1000;
      lastCarTime = timestamp;

      const spdKey = speedSelect.value || 'lv3';
      const cfg = speedConfig[spdKey] || speedConfig.lv3;
      fallSpeed += dt * cfg.accel;

      obstacles.forEach(o => {
        o.y += fallSpeed * dt;
      });

      const carBottomY = carY + carH;

      for (const o of obstacles) {
        if (o.isCorrect && !o.caught && o.y - o.size > carCanvas.height) {
          endGame('car', 'Ê≠£„Åó„ÅÑÊº¢Â≠ó„Çí„Å®„Çä„ÅÆ„Åå„Åó„Åæ„Åó„Åü„ÄÇ');
          return;
        }

        const laneXCenter = laneWidth * o.lane + laneWidth / 2;
        const obsLeft  = laneXCenter - o.size / 2;
        const obsRight = laneXCenter + o.size / 2;
        const obsTop   = o.y;
        const obsBot   = o.y + o.size;

        const carLeft  = laneWidth * carLane + (laneWidth - carW) / 2;
        const carRight = carLeft + carW;
        const carTop   = carY;

        const overlap =
          carLeft < obsRight &&
          carRight > obsLeft &&
          carTop < obsBot &&
          carBottomY > obsTop;

        if (overlap && !o.caught) {
          o.caught = true;
          if (o.isCorrect) {
            score++;
            scoreSpan.textContent = score;
            setupCarQuestion();
            break;
          } else {
            endGame('car', '„Åæ„Å°„Åå„Å£„ÅüÊº¢Â≠ó„Çí„Å≤„Çç„Å£„Å¶„Åó„Åæ„ÅÑ„Åæ„Åó„Åü„ÄÇ');
            return;
          }
        }
      }

      // draw
      carCtx.clearRect(0, 0, carCanvas.width, carCanvas.height);

      carCtx.fillStyle = '#181832';
      carCtx.fillRect(0, 0, carCanvas.width, carCanvas.height);

      carCtx.strokeStyle = '#2a2a4a';
      carCtx.lineWidth = 1;
      for (let i = 1; i < LANES; i++) {
        const x = laneWidth * i;
        carCtx.beginPath();
        carCtx.moveTo(x, 0);
        carCtx.lineTo(x, carCanvas.height);
        carCtx.stroke();
      }

      const carX = laneWidth * carLane + (laneWidth - carW) / 2;
      carCtx.fillStyle = '#0a84ff';
      carCtx.fillRect(carX, carY, carW, carH);
      carCtx.fillStyle = '#000';
      carCtx.fillRect(carX + 5, carY + carH, 10, 6);
      carCtx.fillRect(carX + carW - 15, carY + carH, 10, 6);

      carCtx.textAlign = 'center';
      carCtx.textBaseline = 'middle';
      carCtx.font = '20px -apple-system, sans-serif';

      obstacles.forEach(o => {
        const laneCenter = laneWidth * o.lane + laneWidth / 2;
        carCtx.fillStyle = '#ffcc00';
        carCtx.fillRect(
          laneCenter - o.size / 2,
          o.y,
          o.size,
          o.size
        );
        carCtx.fillStyle = '#000';
        carCtx.fillText(
          o.kanji,
          laneCenter,
          o.y + o.size / 2
        );
      });

      requestAnimationFrame(carLoop);
    }

    // ---- Game control ----
    function startGame() {
      resetCommonState();
      gameRunning = true;
      timeSpan.textContent = timeLeft;
      scoreSpan.textContent = score;

      timerId = setInterval(() => {
        timeLeft--;
        timeSpan.textContent = timeLeft;
        if (timeLeft <= 0) {
          endGame(currentMode);
        }
      }, 1000);

      if (currentMode === 'quiz') {
        setupQuizQuestion();
      } else {
        resetCarState();
        requestAnimationFrame(ts => {
          lastCarTime = ts;
          carLoop(ts);
        });
      }
    }

    function endGame(mode, msgExtra) {
      if (!gameRunning) return;
      gameRunning = false;
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      if (mode === 'quiz') {
        choiceButtons.forEach(btn => btn.disabled = true);
        quizFeedback.textContent = `„Åä„Çè„ÇäÔºÅ „Çπ„Ç≥„Ç¢: ${score}`;
        alert(`„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ „Çπ„Ç≥„Ç¢: ${score}`);
      } else {
        const text = msgExtra
          ? `„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ „Çπ„Ç≥„Ç¢: ${score}\n${msgExtra}`
          : `„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ „Çπ„Ç≥„Ç¢: ${score}`;
        alert(text);
      }
    }

    function activateMode(newMode) {
      if (currentMode === newMode) return;
      gameRunning = false;
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      timeLeft = 60;
      timeSpan.textContent = timeLeft;

      currentMode = newMode;
      if (newMode === 'quiz') {
        quizModeDiv.style.display = 'flex';
        carModeDiv.style.display = 'none';
        modeQuizBtn.classList.add('active');
        modeCarBtn.classList.remove('active');

        quizFeedback.textContent = '';
        choiceButtons.forEach(btn => {
          btn.textContent = '';
          btn.disabled = true;
          btn.classList.remove('correct-show', 'wrong-show');
        });
      } else {
        quizModeDiv.style.display = 'none';
        carModeDiv.style.display = 'flex';
        modeQuizBtn.classList.remove('active');
        modeCarBtn.classList.add('active');
      }

      readingText.textContent = '‚Äî';
      meaningText.textContent = '„Äå„Çπ„Çø„Éº„Éà„Äç„Åß„Ç≤„Éº„É†ÈñãÂßã';
    }

    modeQuizBtn.addEventListener('click', () => activateMode('quiz'));
    modeCarBtn.addEventListener('click', () => activateMode('car'));

    startBtn.addEventListener('click', startGame);
    startBtn.addEventListener('touchstart', e => {
      e.preventDefault();
      startGame();
    }, { passive: false });

    // initial state
    choiceButtons.forEach(btn => btn.disabled = true);
  </script>
</body>
</html>
