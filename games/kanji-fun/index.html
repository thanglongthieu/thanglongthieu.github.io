<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Kanji Fun Game</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #050510;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
      overflow: hidden; /* no scroll on iPhone */
      -webkit-user-select: none;
      user-select: none;
      touch-action: none;
    }

    .app {
      box-sizing: border-box;
      width: 100%;
      height: 100%;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .header {
      text-align: center;
    }

    .title {
      font-size: 22px;
      margin-bottom: 4px;
    }

    .sub {
      font-size: 13px;
      opacity: 0.8;
    }

    .top-bar {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      gap: 8px;
    }

    .top-left {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
    }

    select {
      font-size: 13px;
      padding: 3px 6px;
      border-radius: 6px;
      border: none;
    }

    .stats {
      text-align: right;
      flex: 1;
    }

    .stats span {
      margin-left: 8px;
    }

    .quiz-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: stretch;
      gap: 8px;
    }

    .hint-text {
      text-align: center;
      font-size: 14px;
      opacity: 0.85;
      line-height: 1.4;
      min-height: 36px;
    }

    .reading {
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      margin-top: 4px;
    }

    .meaning {
      font-size: 16px;
      text-align: center;
      opacity: 0.9;
      min-height: 22px;
    }

    .choices {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 10px;
    }

    .choice-btn {
      font-size: 26px;
      padding: 10px 0;
      border-radius: 10px;
      border: none;
      background: #222a40;
      color: #fff;
      transition: transform 0.08s ease, background-color 0.15s ease;
    }

    .choice-btn:active {
      transform: scale(0.94);
    }

    .choice-btn.correct-show {
      background: #1c8f3f;
    }

    .choice-btn.wrong-show {
      background: #b3261e;
    }

    .feedback {
      text-align: center;
      font-size: 14px;
      min-height: 20px;
    }

    .feedback.flash-good {
      animation: flashGood 0.4s;
    }

    .feedback.flash-bad {
      animation: flashBad 0.4s;
    }

    @keyframes flashGood {
      0%   { color: #00ff9d; transform: scale(1); }
      50%  { color: #ffffff; transform: scale(1.06); }
      100% { color: #00ff9d; transform: scale(1); }
    }

    @keyframes flashBad {
      0%   { color: #ff4d4f; transform: scale(1); }
      50%  { color: #ffffff; transform: scale(0.94); }
      100% { color: #ff4d4f; transform: scale(1); }
    }

    .draw-area {
      border-radius: 10px;
      border: 1px solid #444;
      padding: 6px;
      background: #111;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .draw-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .draw-kanji {
      font-size: 32px;
      padding: 0 4px;
    }

    #drawCanvas {
      width: 100%;
      height: 120px;
      background: #fff;
      border-radius: 6px;
      touch-action: none;
    }

    .clear-btn {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: none;
      background: #ff9f0a;
      color: #000;
      transition: transform 0.08s ease;
    }

    .clear-btn:active {
      transform: scale(0.94);
    }

    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .start-btn {
      padding: 8px 18px;
      font-size: 16px;
      border-radius: 999px;
      border: none;
      background: #0a84ff;
      color: #fff;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      box-shadow: 0 4px 10px rgba(10,132,255,0.5);
    }

    .start-btn:active {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 2px 5px rgba(10,132,255,0.4);
    }

    .hint-bottom {
      font-size: 12px;
      text-align: center;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">Kanji Fun Game ‚úçÔ∏è</div>
      <div class="sub">„Çà„Åø Ôºã „ÅÑ„Åø „ÇíË¶ã„Å¶„ÄÅÊ≠£„Åó„ÅÑÊº¢Â≠ó„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Å≠</div>

      <div class="top-bar">
        <div class="top-left">
          <span>„É¨„Éô„É´:</span>
          <select id="levelSelect">
            <option value="easy">„ÇÑ„Åï„Åó„ÅÑÔºàÂ∞è„Åï„ÅÑÂ≠êÂêë„ÅëÔºâ</option>
            <option value="basic">Âü∫Êú¨ÔºàÂ∞èÂ≠¶Áîü„ÄúÔºâ</option>
            <option value="n5">JLPT N5„É¨„Éô„É´</option>
          </select>
        </div>
        <div class="stats">
          <span>‚è± <span id="time">60</span>s</span>
          <span>‚≠ê <span id="score">0</span></span>
          <span>üî• Streak: <span id="streak">0</span></span>
        </div>
      </div>
    </div>

    <div class="quiz-area">
      <div class="hint-text" id="hintText">
        „Äå„Çπ„Çø„Éº„Éà„Äç„ÇíÊäº„Åó„Å¶„Ç≤„Éº„É†ÈñãÂßãÔºÅ<br>
        „Çà„Åø„Å®ÊÑèÂë≥„ÇíË¶ã„Å¶„ÄÅÊ≠£„Åó„ÅÑÊº¢Â≠ó„ÇíÈÅ∏„Åº„ÅÜ„ÄÇ
      </div>
      <div class="reading" id="readingText">‚Äî</div>
      <div class="meaning" id="meaningText">‚Äî</div>

      <div class="choices">
        <button class="choice-btn" data-index="0"></button>
        <button class="choice-btn" data-index="1"></button>
        <button class="choice-btn" data-index="2"></button>
        <button class="choice-btn" data-index="3"></button>
      </div>

      <div class="feedback" id="feedback"></div>
    </div>

    <div class="draw-area">
      <div class="draw-header">
        <span>Êõ∏„Åè„Çå„Çì„Åó„ÇÖ„ÅÜÔºàÊåá„Åß„Å™„Åû„Å£„Å¶„Å≠Ôºâ</span>
        <div>
          „ÅäÊâãÊú¨: <span id="modelKanji" class="draw-kanji">Êº¢</span>
          <button id="clearBtn" class="clear-btn">„Åë„Åô</button>
        </div>
      </div>
      <canvas id="drawCanvas"></canvas>
    </div>

    <div class="controls">
      <button id="startBtn" class="start-btn">„Çπ„Çø„Éº„Éà / „É™„Çπ„Çø„Éº„Éà</button>
      <div class="hint-bottom">
        iPhoneÔºöÁ≠î„Åà„ÅÆ„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó„ÄÅ‰∏ã„ÅÆÁôΩ„ÅÑ„Å®„Åì„Çç„ÅßÊº¢Â≠ó„ÇíÊõ∏„ÅÑ„Å¶„Åø„Çà„ÅÜ„ÄÇ<br/>
        „Çπ„Ç≥„Ç¢„Åß„É©„É≥„ÇØ„ÅåÊ±∫„Åæ„Çã„ÇàÔºÅ
      </div>
    </div>
  </div>

  <script>
    // --- Kanji data sets (can extend later) ---
    const kanjiSets = {
      easy: [
        { kanji: 'Ê∞¥', reading: '„Åø„Åö', meaning: 'water' },
        { kanji: 'ÁÅ´', reading: '„Å≤', meaning: 'fire' },
        { kanji: 'Êú®', reading: '„Åç', meaning: 'tree' },
        { kanji: 'Â±±', reading: '„ÇÑ„Åæ', meaning: 'mountain' },
        { kanji: 'Â∑ù', reading: '„Åã„Çè', meaning: 'river' },
        { kanji: 'Èõ®', reading: '„ÅÇ„ÇÅ', meaning: 'rain' },
        { kanji: 'Âè£', reading: '„Åè„Å°', meaning: 'mouth' },
        { kanji: 'ÁõÆ', reading: '„ÇÅ', meaning: 'eye' },
        { kanji: 'ËÄ≥', reading: '„Åø„Åø', meaning: 'ear' },
        { kanji: 'Êâã', reading: '„Å¶', meaning: 'hand' }
      ],
      basic: [
        { kanji: 'Êó•', reading: '„Å≤ / „Å´„Å°', meaning: 'day / sun' },
        { kanji: 'Êúà', reading: '„Å§„Åç / „Åí„Å§', meaning: 'moon / month' },
        { kanji: 'Áî∞', reading: '„Åü', meaning: 'rice field' },
        { kanji: '‰∫∫', reading: '„Å≤„Å®', meaning: 'person' },
        { kanji: 'Â§ß', reading: '„Åä„Åä(„Åç„ÅÑ)', meaning: 'big' },
        { kanji: 'Â∞è', reading: '„Å°„ÅÑ(„Åï„ÅÑ)', meaning: 'small' },
        { kanji: '‰∏ä', reading: '„ÅÜ„Åà', meaning: 'up / above' },
        { kanji: '‰∏ã', reading: '„Åó„Åü', meaning: 'down / below' },
        { kanji: '‰∏≠', reading: '„Å™„Åã', meaning: 'inside / middle' },
        { kanji: 'Â∑¶', reading: '„Å≤„Å†„Çä', meaning: 'left' },
        { kanji: 'Âè≥', reading: '„Åø„Åé', meaning: 'right' },
        { kanji: 'Ê†°', reading: '„Åì„ÅÜ', meaning: 'school' },
        { kanji: 'ÂÖà', reading: '„Åï„Åç / „Åõ„Çì', meaning: 'ahead / previous' }
      ],
      n5: [
        { kanji: 'Â≠¶', reading: '„Åæ„Å™(„Å∂) / „Åå„Åè', meaning: 'study / learning' },
        { kanji: 'Áîü', reading: '„Åõ„ÅÑ / „ÅÑ(„Åç„Çã)', meaning: 'life / birth' },
        { kanji: 'ÂÖà', reading: '„Åï„Åç / „Åõ„Çì', meaning: 'ahead / previous' },
        { kanji: 'Ê†°', reading: '„Åì„ÅÜ', meaning: 'school' },
        { kanji: 'Ë°å', reading: '„ÅÑ(„Åè) / „Åì„ÅÜ', meaning: 'go / act' },
        { kanji: 'Êù•', reading: '„Åè(„Çã) / „Çâ„ÅÑ', meaning: 'come' },
        { kanji: 'Ë¶ã', reading: '„Åø(„Çã) / „Åë„Çì', meaning: 'see / look' },
        { kanji: 'È£ü', reading: '„Åü(„Åπ„Çã) / „Åó„Çá„Åè', meaning: 'eat / food' },
        { kanji: 'È£≤', reading: '„ÅÆ(„ÇÄ)', meaning: 'drink' },
        { kanji: 'Ë©±', reading: '„ÅØ„Å™(„Åô) / „Çè', meaning: 'talk / speak' },
        { kanji: 'Êõ∏', reading: '„Åã(„Åè)', meaning: 'write' },
        { kanji: 'Ë™≠', reading: '„Çà(„ÇÄ)', meaning: 'read' }
      ]
    };

    // --- DOM elements ---
    const levelSelect = document.getElementById('levelSelect');
    const timeSpan = document.getElementById('time');
    const scoreSpan = document.getElementById('score');
    const streakSpan = document.getElementById('streak');
    const readingText = document.getElementById('readingText');
    const meaningText = document.getElementById('meaningText');
    const feedback = document.getElementById('feedback');
    const hintText = document.getElementById('hintText');
    const startBtn = document.getElementById('startBtn');
    const choiceButtons = Array.from(document.querySelectorAll('.choice-btn'));
    const modelKanji = document.getElementById('modelKanji');

    const drawCanvas = document.getElementById('drawCanvas');
    const clearBtn = document.getElementById('clearBtn');
    const dctx = drawCanvas.getContext('2d');

    // --- Resize drawing canvas to container ---
    function resizeDrawCanvas() {
      const rect = drawCanvas.getBoundingClientRect();
      drawCanvas.width = rect.width;
      drawCanvas.height = rect.height;
      clearDrawing();
    }
    window.addEventListener('resize', resizeDrawCanvas);
    resizeDrawCanvas();

    // --- Game state ---
    let currentQuestion = null;
    let timerId = null;
    let timeLeft = 60;
    let score = 0;
    let streak = 0;
    let bestStreak = 0;
    let gameRunning = false;

    // --- Simple sound engine (Web Audio API) ---
    let audioCtx = null;
    function getAudioCtx() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (AC) {
          audioCtx = new AC();
        }
      }
      return audioCtx;
    }

    function playBeep(type) {
      const ctx = getAudioCtx();
      if (!ctx) return; // no audio support
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      if (type === 'start') {
        osc.frequency.value = 700;
        gain.gain.value = 0.12;
      } else if (type === 'correct') {
        osc.frequency.value = 880;
        gain.gain.value = 0.15;
      } else if (type === 'wrong') {
        osc.frequency.value = 200;
        gain.gain.value = 0.18;
      } else {
        osc.frequency.value = 440;
        gain.gain.value = 0.1;
      }

      osc.type = 'sine';
      osc.connect(gain);
      gain.connect(ctx.destination);

      const now = ctx.currentTime;
      osc.start(now);
      osc.stop(now + 0.18);
      gain.gain.setTargetAtTime(0, now + 0.05, 0.08);
    }

    // --- Helpers ---
    function getCurrentSet() {
      return kanjiSets[levelSelect.value] || kanjiSets.easy;
    }

    function randomFromArray(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function generateQuestion() {
      const set = getCurrentSet();
      const correct = randomFromArray(set);
      currentQuestion = correct;

      readingText.textContent = correct.reading;
      meaningText.textContent = correct.meaning;
      modelKanji.textContent = correct.kanji;

      // Prepare kanji choices
      const allKanji = set.map(k => k.kanji);
      const choices = new Set();
      choices.add(correct.kanji);

      while (choices.size < 4) {
        choices.add(randomFromArray(allKanji));
      }

      const choiceArray = Array.from(choices);
      // Shuffle
      for (let i = choiceArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [choiceArray[i], choiceArray[j]] = [choiceArray[j], choiceArray[i]];
      }

      choiceButtons.forEach((btn, idx) => {
        btn.textContent = choiceArray[idx];
        btn.classList.remove('correct-show', 'wrong-show');
        btn.disabled = !gameRunning;
      });

      feedback.textContent = '';
      feedback.classList.remove('flash-good', 'flash-bad');
      hintText.textContent = '„Çà„Åø„Å®ÊÑèÂë≥„Åã„ÇâÊ≠£„Åó„ÅÑÊº¢Â≠ó„Çí„Åà„Çâ„Åº„ÅÜÔºÅ';
    }

    function updateStreakDisplay() {
      streakSpan.textContent = streak;
    }

    function startGame() {
      gameRunning = true;
      timeLeft = 60;
      score = 0;
      streak = 0;
      updateStreakDisplay();
      timeSpan.textContent = timeLeft;
      scoreSpan.textContent = score;
      feedback.textContent = '';
      feedback.classList.remove('flash-good', 'flash-bad');
      hintText.textContent = '„Åå„Çì„Å∞„Å£„Å¶ÔºÅ 60Áßí„Åß„Åß„Åç„Çã„Å†„Åë„Åü„Åè„Åï„ÇìÊ≠£Ëß£„Åó„Çà„ÅÜüí™';

      playBeep('start');

      if (timerId) clearInterval(timerId);
      timerId = setInterval(() => {
        timeLeft--;
        timeSpan.textContent = timeLeft;
        if (timeLeft <= 0) {
          endGame();
        }
      }, 1000);

      generateQuestion();
    }

    function endGame() {
      gameRunning = false;
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      choiceButtons.forEach(btn => btn.disabled = true);

      // rank by score
      let rank = '';
      if (score >= 25) {
        rank = 'Á•û„É¨„Éô„É´ÔºÅ„Åô„Åî„ÅÑüëè';
      } else if (score >= 15) {
        rank = '„Å®„Å¶„ÇÇ„ÅÑ„ÅÑÔºÅ„Åù„ÅÆË™øÂ≠ê‚ú®';
      } else if (score >= 8) {
        rank = '„ÅÑ„ÅÑÊÑü„ÅòÔºÅ„ÇÇ„Å£„Å®Á∑¥Áøí„Åó„Çà„ÅÜüòä';
      } else {
        rank = '„Åæ„Å†„Åì„Çå„Åã„ÇâÔºÅÂ∞ë„Åó„Åö„Å§Ë¶ö„Åà„Çà„ÅÜüí°';
      }

      feedback.textContent = `„Åä„Çè„ÇäÔºÅ „Çπ„Ç≥„Ç¢: ${score} / ÈÄ£Á∂öÊ≠£Ëß£ÊúÄÂ§ß: ${bestStreak}`;
      alert(`„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ\n„Çπ„Ç≥„Ç¢: ${score}\nÈÄ£Á∂öÊ≠£Ëß£ÊúÄÂ§ß: ${bestStreak}\n\n„É©„É≥„ÇØ: ${rank}`);
      hintText.textContent = '„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÇÑ„Çã„Å®„Åç„ÅØ„Äå„Çπ„Çø„Éº„Éà„Äç„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Å≠„ÄÇ';
    }

    function showFeedback(text, isCorrect) {
      feedback.textContent = text;
      feedback.classList.remove('flash-good', 'flash-bad');
      // force reflow for animation reset
      void feedback.offsetWidth;
      feedback.classList.add(isCorrect ? 'flash-good' : 'flash-bad');
    }

    function handleChoice(btn) {
      if (!gameRunning || !currentQuestion) return;

      const chosen = btn.textContent;
      choiceButtons.forEach(b => b.classList.remove('correct-show', 'wrong-show'));

      if (chosen === currentQuestion.kanji) {
        score++;
        scoreSpan.textContent = score;
        streak++;
        if (streak > bestStreak) bestStreak = streak;
        updateStreakDisplay();
        btn.classList.add('correct-show');
        showFeedback('‚úÖ Ê≠£Ëß£ÔºÅ', true);
        playBeep('correct');
      } else {
        streak = 0;
        updateStreakDisplay();
        btn.classList.add('wrong-show');
        const correctBtn = choiceButtons.find(
          b => b.textContent === currentQuestion.kanji
        );
        if (correctBtn) correctBtn.classList.add('correct-show');
        showFeedback(`‚ùå „Åñ„Çì„Å≠„Çì‚Ä¶ Ê≠£Ëß£„ÅØ„Äå${currentQuestion.kanji}„Äç`, false);
        playBeep('wrong');
      }

      // Next question after short delay
      setTimeout(() => {
        if (gameRunning) generateQuestion();
      }, 650);
    }

    // --- Answer buttons (pointer events work on touch + mouse) ---
    choiceButtons.forEach(btn => {
      btn.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        handleChoice(btn);
      });
    });

    // --- Start button (fixed, works on iPhone SE) ---
    startBtn.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      startGame();
    });

    // --- Mini writing practice (pointer drawing) ---
    let drawing = false;

    function getCanvasPos(evt) {
      const rect = drawCanvas.getBoundingClientRect();
      const x = evt.clientX - rect.left;
      const y = evt.clientY - rect.top;
      return { x, y };
    }

    function clearDrawing() {
      dctx.fillStyle = '#ffffff';
      dctx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
      dctx.lineJoin = 'round';
      dctx.lineCap = 'round';
      dctx.lineWidth = 4;
      dctx.strokeStyle = '#000000';
    }

    function startDraw(evt) {
      evt.preventDefault();
      drawing = true;
      const pos = getCanvasPos(evt);
      dctx.beginPath();
      dctx.moveTo(pos.x, pos.y);
    }

    function moveDraw(evt) {
      if (!drawing) return;
      evt.preventDefault();
      const pos = getCanvasPos(evt);
      dctx.lineTo(pos.x, pos.y);
      dctx.stroke();
    }

    function endDraw(evt) {
      if (!drawing) return;
      evt && evt.preventDefault();
      drawing = false;
      dctx.closePath();
    }

    drawCanvas.addEventListener('pointerdown', startDraw);
    drawCanvas.addEventListener('pointermove', moveDraw);
    drawCanvas.addEventListener('pointerup', endDraw);
    drawCanvas.addEventListener('pointercancel', endDraw);
    drawCanvas.addEventListener('pointerleave', endDraw);

    clearBtn.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      clearDrawing();
    });

    // Initial: disable answer buttons until game starts
    choiceButtons.forEach(b => b.disabled = true);
  </script>
</body>
</html>
