<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Math Quiz (3‚Äì9 √ó 3‚Äì9)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #000;
      color: #fff;
    }
    #container {
      position: fixed;
      inset: 0;
    }
    canvas {
      display: block;
    }
    #hud {
      position: fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: space-between;
      pointer-events: none;
      font-size: 14px;
      text-shadow: 0 0 6px rgba(0,0,0,0.8);
    }
    .hud-box {
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      padding: 6px 10px;
      pointer-events: auto;
    }
    #center-message {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      padding: 16px 20px;
      border-radius: 12px;
      text-align: center;
      font-size: 18px;
      display: none;
    }
    #startBtn, #restartBtn {
      margin-top: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: #1e88e5;
      color: white;
      font-size: 14px;
      font-weight: 600;
    }
    #startBtn:active, #restartBtn:active {
      transform: scale(0.96);
    }
  </style>
</head>
<body>
  <div id="container"></div>

  <div id="hud">
    <div class="hud-box">
      ‚è± Time: <span id="timeDisplay">60</span>s
    </div>
    <div class="hud-box">
      ‚úÖ Score: <span id="scoreDisplay">0</span> |
      üèÜ Best: <span id="bestDisplay">0</span>
    </div>
  </div>

  <div id="center-message">
    <div id="center-text"></div>
    <button id="startBtn">Start</button>
    <button id="restartBtn" style="display:none;">Play Again</button>
  </div>

  <!-- Three.js core + examples (non-module, global THREE) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/FontLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/geometries/TextGeometry.js"></script>

  <script>
    const container = document.getElementById('container');
    const timeDisplay = document.getElementById('timeDisplay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const bestDisplay = document.getElementById('bestDisplay');
    const centerMessage = document.getElementById('center-message');
    const centerText = document.getElementById('center-text');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');

    let bestScore = parseInt(localStorage.getItem('math3d_bestScore') || '0', 10);
    bestDisplay.textContent = bestScore;

    let scene, camera, renderer;
    let raycaster, pointer;
    let font;
    let animationId;

    let currentQuestion = null;
    let answerMeshes = [];
    let timeLeft = 60;
    let timerId = null;
    let score = 0;
    let gameRunning = false;

    init3D();
    loadFont();

    function init3D() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);

      const fov = 45;
      const aspect = window.innerWidth / window.innerHeight;
      camera = new THREE.PerspectiveCamera(fov, aspect, 0.1, 100);
      camera.position.set(0, 1.2, 5);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      container.appendChild(renderer.domElement);

      // Lights
      const ambient = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambient);

      const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
      dirLight.position.set(3, 5, 4);
      scene.add(dirLight);

      // Simple floor
      const floorGeo = new THREE.PlaneGeometry(20, 20);
      const floorMat = new THREE.MeshPhongMaterial({ color: 0x222222 });
      const floor = new THREE.Mesh(floorGeo, floorMat);
      floor.rotation.x = -Math.PI / 2;
      floor.position.y = -1;
      scene.add(floor);

      raycaster = new THREE.Raycaster();
      pointer = new THREE.Vector2();

      window.addEventListener('resize', onWindowResize);
      renderer.domElement.addEventListener('click', onClickOrTap);
      renderer.domElement.addEventListener('touchstart', function (e) {
        if (e.touches.length > 0) {
          const rect = renderer.domElement.getBoundingClientRect();
          const touch = e.touches[0];
          pointer.x = ((touch.clientX - rect.left) / rect.width) * 2 - 1;
          pointer.y = -((touch.clientY - rect.top) / rect.height) * 2 + 1;
          handleAnswerSelection();
        }
      });

      animate();
    }

    function loadFont() {
      const loader = new THREE.FontLoader();
      loader.load(
        'https://unpkg.com/three@0.160.0/examples/fonts/helvetiker_regular.typeface.json',
        function (loadedFont) {
          font = loadedFont;
          showStartScreen();
        },
        undefined,
        function (err) {
          console.error('Font load error', err);
          centerMessage.style.display = 'block';
          centerText.textContent = 'Failed to load font. Check your internet connection.';
          startBtn.style.display = 'none';
        }
      );
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      animationId = requestAnimationFrame(animate);

      // Rotate answers slightly for a dynamic feel
      answerMeshes.forEach(function (mesh, idx) {
        mesh.rotation.y += 0.01 * (idx % 2 === 0 ? 1 : -1);
      });

      renderer.render(scene, camera);
    }

    function showStartScreen() {
      centerMessage.style.display = 'block';
      centerText.innerHTML = '3D Multiplication Quiz<br/><small>3‚Äì9 √ó 3‚Äì9</small>';
      startBtn.style.display = 'inline-block';
      restartBtn.style.display = 'none';
    }

    function startGame() {
      clearQuestion();
      score = 0;
      scoreDisplay.textContent = score;
      timeLeft = 60;
      timeDisplay.textContent = timeLeft;
      gameRunning = true;
      centerMessage.style.display = 'none';

      if (timerId) clearInterval(timerId);
      timerId = setInterval(function () {
        timeLeft -= 1;
        if (timeLeft < 0) timeLeft = 0;
        timeDisplay.textContent = timeLeft;
        if (timeLeft <= 0) {
          endGame();
        }
      }, 1000);

      nextQuestion();
    }

    function endGame() {
      gameRunning = false;
      clearInterval(timerId);
      timerId = null;

      if (score > bestScore) {
        bestScore = score;
        localStorage.setItem('math3d_bestScore', String(bestScore));
        bestDisplay.textContent = bestScore;
      }

      centerMessage.style.display = 'block';
      centerText.innerHTML = 'Time up!<br/>Score: ' + score + '<br/>Best: ' + bestScore;
      startBtn.style.display = 'none';
      restartBtn.style.display = 'inline-block';
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateQuestion() {
      const a = randomInt(3, 9);
      const b = randomInt(3, 9);
      const correct = a * b;

      const answers = new Set();
      answers.add(correct);
      while (answers.size < 4) {
        let delta = randomInt(-5, 5);
        if (delta === 0) continue;
        const candidate = correct + delta;
        if (candidate >= 9 && candidate <= 81) {
          answers.add(candidate);
        }
      }

      const answerArray = Array.from(answers);
      // shuffle
      for (let i = answerArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const tmp = answerArray[i];
        answerArray[i] = answerArray[j];
        answerArray[j] = tmp;
      }

      return {
        a: a,
        b: b,
        correct: correct,
        answers: answerArray
      };
    }

    function clearQuestion() {
      if (currentQuestion && currentQuestion.questionMesh) {
        scene.remove(currentQuestion.questionMesh);
      }
      answerMeshes.forEach(function (m) { scene.remove(m); });
      answerMeshes = [];
      currentQuestion = null;
    }

    function createTextMesh(text, size, height) {
      size = size || 0.6;
      height = height || 0.15;
      const geometry = new THREE.TextGeometry(text, {
        font: font,
        size: size,
        height: height,
        curveSegments: 8,
        bevelEnabled: false
      });
      geometry.computeBoundingBox();
      geometry.center();
      const material = new THREE.MeshPhongMaterial({ color: 0xffffff });
      return new THREE.Mesh(geometry, material);
    }

    function createAnswerMesh(value) {
      const group = new THREE.Group();

      const boxGeo = new THREE.BoxGeometry(1.4, 0.8, 0.3);
      const boxMat = new THREE.MeshPhongMaterial({ color: 0x1565c0 });
      const box = new THREE.Mesh(boxGeo, boxMat);
      group.add(box);

      const numMesh = createTextMesh(String(value), 0.4, 0.08);
      numMesh.position.z = 0.16;
      group.add(numMesh);

      group.userData.answerValue = value;
      return group;
    }

    function nextQuestion() {
      clearQuestion();
      currentQuestion = generateQuestion();

      // Question text mesh
      const qText = currentQuestion.a + ' √ó ' + currentQuestion.b + ' = ?';
      const qMesh = createTextMesh(qText, 0.6, 0.18);
      qMesh.position.set(0, 1, 0);
      scene.add(qMesh);
      currentQuestion.questionMesh = qMesh;

      // Answer meshes in semi-circle
      const radius = 3;
      const baseY = 0;
      const angles = [-0.9, -0.3, 0.3, 0.9];

      currentQuestion.answers.forEach(function (ans, idx) {
        const mesh = createAnswerMesh(ans);
        const angle = angles[idx];
        mesh.position.set(
          Math.sin(angle) * radius,
          baseY,
          Math.cos(angle) * radius
        );
        mesh.lookAt(0, 0.3, 0); // face center
        scene.add(mesh);
        answerMeshes.push(mesh);
      });
    }

    function onClickOrTap(event) {
      const rect = renderer.domElement.getBoundingClientRect();
      const x = event.clientX;
      const y = event.clientY;
      if (x == null || y == null) return;
      pointer.x = ((x - rect.left) / rect.width) * 2 - 1;
      pointer.y = -((y - rect.top) / rect.height) * 2 + 1;
      handleAnswerSelection();
    }

    function handleAnswerSelection() {
      if (!gameRunning) return;
      raycaster.setFromCamera(pointer, camera);
      const intersects = raycaster.intersectObjects(answerMeshes, true);
      if (intersects.length > 0) {
        let obj = intersects[0].object;
        while (obj && !('answerValue' in obj.userData) && obj.parent) {
          obj = obj.parent;
        }
        if (!obj || !('answerValue' in obj.userData)) return;
        const value = obj.userData.answerValue;
        if (value === currentQuestion.correct) {
          score += 1;
          scoreDisplay.textContent = score;
          nextQuestion();
        } else {
          if (score > 0) {
            score -= 1;
            scoreDisplay.textContent = score;
          }
          obj.scale.set(1.1, 1.1, 1.1);
          setTimeout(function () {
            obj.scale.set(1, 1, 1);
          }, 150);
        }
      }
    }

    startBtn.addEventListener('click', startGame);
    restartBtn.addEventListener('click', startGame);
  </script>
</body>
</html>
